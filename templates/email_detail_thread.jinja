
        <div id="email-detail-pane"
             class="h-full p-6 bg-white border-l border-gray-200 overflow-y-auto custom-scroll shadow-xl">

            <!-- THREAD CONTAINER: Messages are ordered oldest to newest (top to bottom) -->
            <div id="thread-end" class="space-y-6">

                {% for email in thread_emails %}
                <!-- Thread Message {{ loop.index }} -->
                <div class="ml-0 border-l-2 border-indigo-200 pl-4 py-4 bg-white shadow-sm rounded-lg transition duration-300 hover:shadow-md">
                    <div {% if loop.first %}id="email-header"{% endif %} class="flex justify-between items-start mb-{% if loop.first %}4{% else %}2{% endif %} {% if loop.first %}border-b border-gray-100 pb-2{% endif %}">
                        <div class="space-y-1">
                            {% if loop.first %}
                            <h2 class="text-2xl font-extrabold text-gray-900">{{email.subject}}</h2>
                            {% endif %}
                            <p class="text-sm font-{% if loop.first %}medium{% else %}semibold{% endif %} text-gray-{% if loop.first %}600{% else %}900{% endif %}">{% if loop.first %}From: {% endif %}{{email.from_email}}</p>
                        </div>
                        <div class="flex flex-col items-end space-y-2 pt-1">
                            <span class="text-xs text-gray-400">{{email.date}}</span>
                            {% if loop.first %}
                            <span class="flex items-center space-x-1 text-sm font-semibold text-gray-600 bg-gray-100 px-2 py-0.5 rounded-full">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                                </svg>
                                <span>{{thread_count}} messages</span>
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% if email.attachments and email.attachments|length > 0 %}
                        <div class="flex flex-wrap gap-2 mt-4">
                        {% for att in email.attachments %}
                            <a href="/api/attachment/{{email.message_id}}/{{att['filename']}}" target="_blank">
                            <span class="inline-flex items-center px-3 py-1 text-sm font-medium bg-white text-gray-700 rounded-full border border-indigo-300 shadow-sm transition duration-150 hover:bg-indigo-50 cursor-pointer">
                                <!-- Paperclip Icon -->
                                <svg class="w-4 h-4 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                                {{att['filename']}}
                                <span class="ml-2 text-xs text-indigo-400 font-normal">{{ '%.02f' % (att['size_bytes']/(1024*1024))}}MB</span>
                            </span>
                            </a>
                        {% endfor %}
                        </div>
                    {% endif %}
                    <textarea
                        id="htmlInput-{{loop.index}}"
                        style="display:none"
                        class="email-content-input"
                        placeholder="Enter HTML content here..."
                    >{{email.parsed_body|safe}}</textarea>
                    <div class="border-2 border-slate-200 rounded-lg overflow-hidden bg-slate-50">
                        <span id="iframeHeight-{{loop.index}}" class="text-sm text-slate-500"></span>
                        <iframe
                            id="contentFrame-{{loop.index}}"
                            class="email-iframe w-full border-0 bg-white"
                            sandbox="allow-same-origin allow-scripts"
                            style="min-height: 200px;"
                        ></iframe>
                    </div>
                </div>
                {% endfor %}

         </div>
         <!-- End of Thread Container -->
         <script>
            console.log('Loading thread email content');

            // Load content into a specific iframe
            function loadContentIntoIframe(iframe, htmlInput, heightDisplay) {
                const htmlContent = htmlInput.value || '<p style="padding: 20px;">No content available</p>';
                const iframeId = iframe.id;

                // Wrap content with resize script
                const wrappedContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            body { margin: 0; padding: 16px; font-family: system-ui, -apple-system, sans-serif; }
                        </style>
                    </head>
                    <body>
                        ${htmlContent}
                        <script>
                            // Send height updates to parent
                            function sendHeight() {
                                try {
                                    const height = Math.max(
                                        document.body.scrollHeight,
                                        document.documentElement.scrollHeight,
                                        document.body.offsetHeight,
                                        document.documentElement.offsetHeight
                                    );

                                    window.parent.postMessage({
                                        type: 'resize',
                                        height: height,
                                        iframeId: '${iframeId}'
                                    }, '*');
                                } catch(e) {
                                    console.error('Failed to send height:', e);
                                }
                            }

                            // Wait for DOM to be ready
                            if (document.readyState === 'loading') {
                                document.addEventListener('DOMContentLoaded', sendHeight);
                            } else {
                                sendHeight();
                            }

                            // Send after delays to ensure rendering
                            setTimeout(sendHeight, 50);
                            setTimeout(sendHeight, 200);
                            setTimeout(sendHeight, 500);

                            // Watch for changes
                            const observer = new MutationObserver(function() {
                                setTimeout(sendHeight, 10);
                            });

                            observer.observe(document.body, {
                                attributes: true,
                                childList: true,
                                subtree: true
                            });

                            // Watch for resize
                            window.addEventListener('resize', sendHeight);

                            // Watch for images loading
                            setTimeout(function() {
                                document.querySelectorAll('img').forEach(img => {
                                    if (!img.complete) {
                                        img.addEventListener('load', sendHeight);
                                    }
                                });
                            }, 0);
                        <\/script>
                    </body>
                    </html>
                `;

                iframe.srcdoc = wrappedContent;
            }

            // Listen for resize messages from all iframes
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'resize' && event.data.iframeId) {
                    const iframe = document.getElementById(event.data.iframeId);
                    if (iframe) {
                        const height = event.data.height;
                        iframe.style.height = height + 'px';

                        const heightDisplay = document.getElementById(event.data.iframeId.replace('contentFrame', 'iframeHeight'));
                        if (heightDisplay) {
                            heightDisplay.textContent = `Height: ${height}px`;
                        }
                    }
                }
            }, false);

            // Initialize all email iframes
            document.querySelectorAll('.email-iframe').forEach(function(iframe, index) {
                const inputId = 'htmlInput-' + (index + 1);
                const heightId = 'iframeHeight-' + (index + 1);
                const htmlInput = document.getElementById(inputId);
                const heightDisplay = document.getElementById(heightId);

                if (htmlInput && heightDisplay) {
                    loadContentIntoIframe(iframe, htmlInput, heightDisplay);

                    // Also handle iframe load event
                    iframe.addEventListener('load', function() {
                        setTimeout(function() {
                            try {
                                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                if (iframeDoc) {
                                    const height = iframeDoc.documentElement.scrollHeight;
                                    iframe.style.height = height + 'px';
                                    if (heightDisplay) {
                                        heightDisplay.textContent = `Height: ${height}px (direct)`;
                                    }
                                }
                            } catch(e) {
                                console.log('Direct access blocked, relying on postMessage');
                            }
                        }, 100);
                    });
                }
            });
         </script>
</div>